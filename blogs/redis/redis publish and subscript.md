# 【Redis-5.0】发布/订阅
## 发布/订阅模式的简介
订阅、取消订阅和发布实现了发布/订阅消息范式，发布者不是计划发送消息给特定的订阅者，而是发布消息到不同的频道，并不需要知道什么样的订阅者订阅。订阅者对一个或多个频道感兴趣，只需接收感兴趣的消息，不需要知道什么样的发布者发布的。这种发布者和订阅者的解耦合可以带来更大的扩展性和更加动态的网络拓扑。

## Redis的Pub/Sub模式的使用方式
在Redis中，为了订阅foo和bar，客户端发出一个订阅的命令：
```
SUBSCRIBE foo bar
```
其他客户端发布这些频道的消息将会被推送到所有订阅的客户端：
```
PUBLISH foo someMessage
```
并且客户端可以在需要的时候取消订阅：
```
UNSUBSCRIBE foo
```
如果没有指定取消订阅的频道，则表示取消订阅所有频道。

#### 频道的模式匹配
Redis的Pub/Sub实现支持模式匹配。客户端可以订阅全风格的模式以便接收所有来自能匹配到给定模式的频道的消息，比如：
```
PSUBSCRIBE news.*
```
将接收所有发到news.art.figurative, news.music.jazz等等的消息，所有模式都是有效的，所以支持多通配符。
```
PUNSUBSCRIBE news.*
```
以上命令将取消订阅匹配该模式的客户端，这个调用不影响其他订阅。

客户端可能多次接收一个消息，如果它订阅的多个模式匹配了同一个发布的消息，或者它订阅的模式和频道同时匹配到一个消息。就像下面的例子：
```
SUBSCRIBE foo
PSUBSCRIBE f*
```
这样的话，如果一个消息被发送到foo，客户端会接收到两条消息：一条message类型，一条pmessage类型。

#### 作用域
发布/订阅与key所在空间没有关系，它不会受任何级别的干扰，包括不同数据库编码。发布在db 10，订阅可以在db 1。如果你需要区分某些频道，可以通过在频道名称前面加上所在环境的名称的前缀（例如：测试环境，演示环境，线上环境等）。

## Redis的Pub/Sub模式的缺点
#### 数据可靠性无法保证
客户端发送消息的时候，消息是无状态的，也就是说负责发送消息的客户端只管发送消息，并不会理会消息是否被订阅者接收到，也不会理会是否在传输过程中丢失，即对于发布者来说，消息是“即发即失”的，并且Redis服务端也不会保存消息，这就会导致在消息订阅者还没有开始订阅的时候，消息发布者发布了一些消息，那么这些消息对于消息订阅者来说是永远也接收不到的。

#### 扩展性差
不能通过增加消费者来加快消耗发布者写入的数据，如果发布者发布的消息很多，则数据阻塞在通道中以等待被消费着来消耗。阻塞时间越久，数据丢失的风险越大（网络或者服务器的一个不稳定就会导致数据的丢失）

#### 资源消耗高
在pub/sub中消息发布者不需要独占一个Redis链接，而消费者则需要单独占用一个Redis链接，在java中便不得不独立分出一个线程来处理一个消费者。
