# 【mysql】事务
## 事务的四大特性（ACID）
* 原子性（Atomicity）：指一个事务中所包含的所有数据库操作要么全部成功，要么全部失败回滚。
* 一致性（Consistency）：指一个事务必须使数据库从一个一致性状态变换到另一个一致性状态，也就是说一个事务执行之前和执行之后都必须处于一致性状态。例如用户A和用户B两者的钱加起来一共是5000，那么不管A和B之间如何转账，转几次账，事务结束后两个用户的钱相加起来应该还得是5000，这就是事务的一致性。
* 隔离性（Isolation）：指多个用户并发访问数据库时（比如操作同一张表），数据库为每一个用户开启的事务，不能被其他事务的操作所干扰，多个并发事务之间要相互隔离。
* 持久性（Durability）：指一个事务一旦被提交了，那么对数据库中的数据的改变就是永久性的，即便是在数据库系统遇到故障的情况下也不会丢失提交事务的操作。

注：原子性和一致性的区别在于**原子性强调的是操作方面**，而**一致性强调的是数据方面**。通过事务的原子性、隔离性和持久性，可以确保事务的一致性。

## 如果不考虑事务的隔离性，会发生的问题
* 脏读：指在一个事务处理过程里读取了另一个未提交的事务中的数据。当一个事务正在多次修改某个数据，而在这个事务中这些修改都还未提交，这时一个并发的事务来访问该数据，就会造成两个事务得到的数据不一致。
    
    ![transaction01](./images/transaction01.png)
* 不可重复读：指在对于数据库中的某一条数据，一个事务范围内多次查询却返回了不同的数据**值**，这是由于整个事务比较大，前后读取同一条数据需要经历很长的时间，在查询间隔，被另一个事务修改并提交了。

    ![transaction02](./images/transaction02.png)
* 幻读：指在一个事务范围内多次查询却返回了不同的数据**量**。例如事务T1对一个表中所有的行数进行统计操作，这时事务T2又对这个表中插入了一行数据项，而操作事务T1的用户如果再对所有的行数进行统计操作，会发现数据总量不一样，其实这多出来的那一行是从事务T2中添加的，就好像产生幻觉一样，这就是发生了幻读。

    ![transaction03](./images/transaction03.png)

注：不可重复读和幻读的区别在于**不可重复读强调的是修改操作（只需要锁住行，性能消耗较小）**，而**幻读强调的是新增或删除操作（需要锁住表，性能消耗大）**。

## MySQL数据库为我们提供的四种隔离级别
* Serializable (串行化)：可避免脏读、不可重复读、幻读的发生。
* Repeatable read (可重复读)：可避免脏读、不可重复读的发生。（默认）
* Read committed (读已提交)：可避免脏读的发生。
* Read uncommitted (读未提交)：最低级别，任何情况都无法保证。
  
而在Oracle数据库中，只支持Serializable (串行化)级别和Read committed (读已提交)这两种级别，其中默认的为Read committed级别。

Spring框架中也实现了以上四种事务隔离级别。此外其还提供了DEFAULT级别，用于表示使用数据库本身使用的隔离级别。Spring建议使用DEFAULT，就是数据库本身的隔离级别，配置好数据库本身的隔离级别，无论在哪个框架中读写数据都不用操心了，而且万一Spring没有把这几种隔离级别实现的很完善，出了问题就麻烦了。

Spring中通过`@Transactional(rollbackFor=Exception.class)`注解来开启事务（不支持静态方法），其底层原理是aop切面。通过`TransactionAspectSupport.currentTransactionStatus().setRollbackOnly()`来手动回滚事务。
