# 【微服务—分布式事务解决方案】基于XA协议的两阶段提交方案
## 基于XA协议的两阶段提交方案

### 其中有两种角色，事务协调者和事务参与者

### 其中的事务控制分为两个阶段
* 第一阶段：首先事务协调者通知各个事务参与者，让它们开始准备事务，然后各个事务参与者接收到消息后开始准备阶段，写好事务日志并执行事务，但不提交，然后将是否就绪的消息返回给事务协调者。

* 第二阶段：首先事务协调者在接收各个消息后，开始分析，如果有任意一个事务参与者失败了，则向所有事务参与者发送回滚命令，否则发送提交命令；然后各个事务参与者接收到命令后，提交事务，并将提交后得到的消息返回给事务协调者。

### 为什么要分成两个阶段
* 分成两个阶段，使得事务协调者能够统一管理事务。
* 分成两个阶段可以尽可能晚地提交事务，让事务在提交前尽可能地完成所有能完成的工作，这样，最后的提交阶段将是耗时极短，耗时极短意味着将操作失败的可能性降到最低。
* 分成两个阶段提交是为了保证事务的一致性，不管是事务协调者还是各个事务参与者，每执行一步操作，都会记录日志，为出现故障后的恢复操作做好准备。

### 弊端
* 协议是阻塞的：事务协调者需要等待所有的事务参与者都返回响应后，才能继续下一步操作。事务协调者需要收集各个事务参与者的响应消息，如果其中一个或多个一直不返回消息，则事务协调者一直等待，应用程序也被阻塞，甚至可能永久阻塞。
* 网络容错能力差：只要有一个事务参与者失败了（网络超时或者宕机），事务协调者需要一直等待直到超时。
* 事务协调者单点故障：在第二阶段中，当事务协调者未发出“正式提交” 就宕机时，参与者将进入“未知”状态，完全不知道下一步该怎么办，只能重新发送第一阶段中的“可以提交”响应或者超时等待。
